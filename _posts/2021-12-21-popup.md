---
layout: post
title: mapbox-gl中实现自定义的popup
date: 2021-12-21 15:37:44 +0800
tags: Vue 阿里云服务器
---

# `mapbox-gl`中实现自定义的`popup`

### 通用思路

1. `mapbox-gl`的内部方法`new mapboxgl.Popup`，其`setHTML`方法可以传入代码片段，在该方法中定义好`html`内容和对应`class`，外部使用`css`控制样式即可，缺点是不够灵活，对于复杂的弹框样式实现起来很麻烦

2. 独立的`popup`弹框，通过数据驱动`popup`与地图关联，如监听地图点击事件，触发popup的显隐及数据的更新，缺点是与地图的联动不够有机，需要考虑很多细节，比如地图移动和缩放时弹框位置也应该随之变化，不像内部`popup`已经做好了这方面的关联

### 优化方法

鉴于第二种方法相对复杂，这里选择方法一，同时结合`vue`的组件化，将`Popup`样式和内容写成一个组件，这样就能 用通用的`vue`语法来开发`popup`，兼具方法一和方法二的优点

考虑组件化，难点在于直接将组件直接写进`setHTML`是行不通的`setHTML(InfoPopup)`，因为`mapbox`加载`Popup`的方式只支持原生的`html`，`vue`语法传进去也是以原生语法来处理，并不会经过`vue`的编译处理

优化后的处理方法如下（本文使用`vue 3.0`语法）：

1. `popup`组件
    
    ```
    ...
    import { toRefs } from '@vue/reactivity'

    export default {
      name: 'InfoPopup',
      props: ['buildingInfosProp'],
      setup (props) {
        const { buildingInfosProp } = toRefs(props)

        return {
          buildingInfos: buildingInfosProp
        }
      }
    }
    ```

    解构赋值会消除`props`属性的响应式，因此用`toRefs`进行包装

2. 地图组件

    ```
    import InfoPopup from './infoPopup.vue'
    import { ref, createApp } from 'vue'
    ...
    export default {
      name: 'Home',
      setup () {
        const buildingInfos = ref({})
        const setBuildingInfos = (infos) => {
          buildingInfos.value = infos
        }
        
        const popDetail = createApp(InfoPopup, {
          buildingInfosProp: buildingInfos
        })
        const mountInfoPopup = () => {
          popDetail.mount('#building-popup')
        }
        ...
        return {
          buildingInfos,
          setBuildingInfos,
          mountInfoPopup,
          getCenterPoint,
        }
      },
      
    }
    ```

    在`setup`中创建响应式数据`buildingInfos`和修改`buildingInfos`的方法，通过`createApp`方法创建一个以`InfoPopup`为根组件的`vue`实例对象，第二个参数是传入`props`数据的，这里传入响应式的`buildingInfos`，这样当`buildingInfos`改变时，`popup`组件也会自动更新渲染。现在实例已创建，接下来便是将其挂载到对应元素节点上，也就是通过`setHTML`创建的内部`popup`之下

    ```
    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point)
      if (features.length) {
        const coordinates = this.getCenterPoint(features[0].geometry.coordinates[0])
        this.setBuildingInfos(features[0].properties)
        if (!this.buildingPopup) {
          this.buildingPopup = new mapboxgl.Popup({
            className: 'building-popup-container'
          }).setLngLat(coordinates)
            .setHTML('<div id="building-popup" class="building-popup"></div>')
            .addTo(map)
          this.mountInfoPopup()
        } else {
          this.buildingPopup.setLngLat(coordinates).addTo(map)
        }
      } else {
        if (this.buildingPopup) {
          this.buildingPopup.remove()
        }
      }
    })
    ```

    `map.queryRenderedFeatures`获取当前点击位置包含的要素列表，如果不为空，说明click在了要素上，应该展示弹框。获取该要素的信息并赋给`buildingInfos`，如果`this.buildingPopup`不存在，说明弹框还未初始化过，需要先创建弹框`new mapboxgl.Popup`，然后将之前的`InfoPopup`组件实例挂载到`id="building-popup"`的元素上，最后设置弹框位置并添加到地图图层即可。如果点击的位置不是要素，则关闭弹框